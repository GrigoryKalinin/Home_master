{% extends "base.html" %} 
{% load static %}

{% block style %} 
<link rel="stylesheet" href="{% static 'css/landing.css' %}" />
<link rel="stylesheet" href="{% static 'css/modal.css' %}" />
{% endblock style %} 

{% block content %}

<!-- Герой-секция -->
<section class="hero">
<div class="container">
    <!-- TODO информация и ссылка на заявку -->
    <h1>Профессиональный ремонт и обслуживание</h1>
    <p>Мы предоставляем качественные услуги по ремонту и обслуживанию для вашего дома и офиса. Наши мастера с многолетним опытом готовы помочь вам в любое время.</p>
    <button class="btn btn-primary" data-bs-toggle='modal' data-bs-target='#orderModal'>Заказать услугу</button>
</div>
</section>

<!-- Услуги -->
<section class="services" id="services">
<div class="container">
    <div class="section-title">
        <h2>Наши услуги</h2>
        <p>Мы предлагаем широкий спектр услуг по ремонту и обслуживанию для вашего удобства</p>
    </div>

    <div class='services-grid'>
        {% for category in categories %}
            <div class='service-card'>
                <!-- TODO решить проблему с размером фотографии
                <div class="service-img">
                    <img src="{{category.image.url}}" alt="{{category.name}}"> 
                </div>
                -->
                <!-- TODO поработать с визуализацией (всё должно быть на одном уровне) -->
                <div class="service-content">
                    <h3>{{category.name}}</h3>
                    {% for product in category.products.all|dictsortreversed:'popularity'|slice:":2" %}
                        <p>{{product.name}}</p>
                    {% endfor %}
                    <button class='btn btn-secondary'>Подробнее</button>
                </div>
            </div>
        {% endfor %}
    </div>

</div>
</section>

<!-- О нас -->
<!-- TODO информация о компании добавить ссылку на кнопку "узнать больше"-->
<section class="about" id="about">
<div class="container">
    <div class="about-content">
        <div class="about-text">
            <h2>О нашей компании</h2>
            <p>Мы - команда профессиональных мастеров с многолетним опытом работы в сфере ремонта и обслуживания. Наша компания была основана в 2010 году и с тех пор мы помогли тысячам клиентов решить их бытовые проблемы.</p>
            <p>Наши мастера проходят строгий отбор и регулярное обучение, чтобы предоставлять вам услуги высочайшего качества. Мы используем только проверенные материалы и инструменты от ведущих производителей.</p>
            <p>Гарантия на все виды работ - 1 год. Мы дорожим своей репутацией и всегда отвечаем за качество наших услуг.</p>
            <button class="btn btn-outline">Узнать больше</button>
        </div>
        <div class="about-image" style="background-image: url('https://example.com/about-team.jpg');"></div> <!-- TODO сделать картинку -->
    </div>
</div>
</section>

<!-- Отзывы -->
<!-- TODO сделать редерин отзывов с бд -->
<section class="testimonials" id="reviews">
<div class="container">
    <div class="section-title">
        <h2>Отзывы наших клиентов</h2>
        <p>Что говорят о нас люди, которые уже воспользовались нашими услугами</p>
    </div>
    <div class="testimonials-grid">
        <div class="testimonial-card">
            <div class="stars">
                <i class="fas fa-star"></i>
                <i class="fas fa-star"></i>
                <i class="fas fa-star"></i>
                <i class="fas fa-star"></i>
                <i class="fas fa-star"></i>
            </div>
            <p>"Очень доволен работой мастера по сантехнике. Приехал вовремя, быстро нашел проблему и устранил ее. Цена соответствовала озвученной заранее. Рекомендую!"</p>
            <div class="testimonial-author">
                <div class="author-avatar" style="background-image: url('https://example.com/avatar1.jpg');"></div>
                <div class="author-info">
                    <h4>Александр Петров</h4>
                    <p>Москва</p>
                </div>
            </div>
        </div>
        <div class="testimonial-card">
            <div class="stars">
                <i class="fas fa-star"></i>
                <i class="fas fa-star"></i>
                <i class="fas fa-star"></i>
                <i class="fas fa-star"></i>
                <i class="fas fa-star"></i>
            </div>
            <p>"Заказывала сборку кухни из IKEA. Мастер приехал точно в назначенное время, работал аккуратно и профессионально. Кухня собрана идеально, все работает. Спасибо!"</p>
            <div class="testimonial-author">
                <div class="author-avatar" style="background-image: url('https://example.com/avatar2.jpg');"></div>
                <div class="author-info">
                    <h4>Елена Смирнова</h4>
                    <p>Санкт-Петербург</p>
                </div>
            </div>
        </div>
        <div class="testimonial-card">
            <div class="stars">
                <i class="fas fa-star"></i>
                <i class="fas fa-star"></i>
                <i class="fas fa-star"></i>
                <i class="fas fa-star"></i>
                <i class="fas fa-star-half-alt"></i>
            </div>
            <p>"Вызвал электрика для замены проводки в квартире. Работа выполнена качественно, все аккуратно, мусор убрали после себя. Цена немного выше средней, но качество того стоит."</p>
            <div class="testimonial-author">
                <div class="author-avatar" style="background-image: url('https://example.com/avatar3.jpg');"></div>
                <div class="author-info">
                    <h4>Дмитрий Иванов</h4>
                    <p>Казань</p>
                </div>
            </div>
        </div>
    </div>
</div>
</section>

<!-- CTA -->
<section class="cta">
<div class="container">
    <h2>Готовы помочь вам прямо сейчас!</h2>
    <p>Оставьте заявку и наш мастер свяжется с вами в течение 15 минут для уточнения деталей и согласования времени визита.</p>
    <!-- TODO сделать ссылку на форму заявки -->
    <button class="btn btn-primary">Оставить заявку</button>
</div>
</section>

<!-- Модальное окно -->
{% include "main/order/modal.html" with form=order_form %}

{% endblock content %}

{% block script %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const orderForm = document.getElementById('orderForm');
    const submitBtn = document.getElementById('submitOrderBtn');
    const spinner = submitBtn.querySelector('.spinner-border');
    const messagesDiv = document.getElementById('form-messages');
    const modal = new bootstrap.Modal(document.getElementById('orderModal'));

    orderForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        // Показываем спиннер
        spinner.classList.remove('d-none');
        submitBtn.disabled = true;
        messagesDiv.innerHTML = '';

        const formData = new FormData(orderForm);

        fetch(orderForm.action, {
            method: 'POST',
            body: formData,
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'X-CSRFToken': formData.get('csrfmiddlewaretoken')
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Успешная отправка
                messagesDiv.innerHTML = `
                    <div class="alert alert-success">
                        ${data.message}
                    </div>
                `;
                orderForm.reset();
                setTimeout(() => {
                    modal.hide();
                    messagesDiv.innerHTML = '';
                }, 2000);
            } else {
                // Ошибки валидации
                let errorHtml = '<div class="alert alert-danger"><ul class="mb-0">';
                for (const [field, errors] of Object.entries(data.errors)) {
                    errors.forEach(error => {
                        errorHtml += `<li>${error}</li>`;
                    });
                }
                errorHtml += '</ul></div>';
                messagesDiv.innerHTML = errorHtml;
            }
        })
        .catch(error => {
            console.error('Error:', error);
            messagesDiv.innerHTML = `
                <div class="alert alert-danger">
                    Произошла ошибка при отправке заявки. Попробуйте еще раз.
                </div>
            `;
        })
        .finally(() => {
            // Скрываем спиннер
            spinner.classList.add('d-none');
            submitBtn.disabled = false;
        });
    });

    // Очистка формы при закрытии модального окна
    document.getElementById('orderModal').addEventListener('hidden.bs.modal', function() {
        orderForm.reset();
        messagesDiv.innerHTML = '';
        spinner.classList.add('d-none');
        submitBtn.disabled = false;
    });
});
</script>
{% endblock script %}
