{% extends 'private/employee_base.html' %}
{% load static %}

{% block title %}{{ title }}{% endblock title %}

{% block content %}
<div class="container mt-4">
  <div class="row justify-content-center">
    <div class="col-md-8">
      <div class="card">
        <div class="card-header">
          <h4 class="mb-0">{{ title }}</h4>
        </div>
        <div class="card-body">
          <form method="post" enctype="multipart/form-data">
            {% csrf_token %}
            
            <div class="row">
              <div class="col-md-6">
                <h6 class="text-muted mb-3">Информация о клиенте</h6>
                
                <div class="mb-3">
                  <label for="{{ form.name.id_for_label }}" class="form-label">{{ form.name.label }}</label>
                  {{ form.name }}
                  {% if form.name.errors %}
                    <div class="text-danger small">{{ form.name.errors.0 }}</div>
                  {% endif %}
                </div>
                
                <div class="mb-3">
                  <label for="{{ form.last_name.id_for_label }}" class="form-label">{{ form.last_name.label }}</label>
                  {{ form.last_name }}
                  {% if form.last_name.errors %}
                    <div class="text-danger small">{{ form.last_name.errors.0 }}</div>
                  {% endif %}
                </div>
                
                <div class="mb-3">
                  <label for="{{ form.middle_name.id_for_label }}" class="form-label">{{ form.middle_name.label }}</label>
                  {{ form.middle_name }}
                  {% if form.middle_name.errors %}
                    <div class="text-danger small">{{ form.middle_name.errors.0 }}</div>
                  {% endif %}
                </div>
                
                <div class="mb-3">
                  <label for="{{ form.phone.id_for_label }}" class="form-label">{{ form.phone.label }}</label>
                  {{ form.phone }}
                  {% if form.phone.errors %}
                    <div class="text-danger small">{{ form.phone.errors.0 }}</div>
                  {% endif %}
                </div>
                
                <div class="mb-3">
                  <label for="{{ form.city.id_for_label }}" class="form-label">{{ form.city.label }}</label>
                  {{ form.city }}
                  {% if form.city.errors %}
                    <div class="text-danger small">{{ form.city.errors.0 }}</div>
                  {% endif %}
                </div>
                
                <div class="mb-3">
                  <label for="{{ form.address.id_for_label }}" class="form-label">{{ form.address.label }}</label>
                  {{ form.address }}
                  {% if form.address.errors %}
                    <div class="text-danger small">{{ form.address.errors.0 }}</div>
                  {% endif %}
                </div>
              </div>
              
              <div class="col-md-6">
                <h6 class="text-muted mb-3">Информация о работе</h6>
                
                <div class="mb-3">
                  <label for="{{ form.work_description.id_for_label }}" class="form-label">{{ form.work_description.label }}</label>
                  {{ form.work_description }}
                  {% if form.work_description.errors %}
                    <div class="text-danger small">{{ form.work_description.errors.0 }}</div>
                  {% endif %}
                </div>
                
                <div class="mb-3">
                  <label for="additional_images" class="form-label">Дополнительные фотографии</label>
                  <input type="file" name="additional_images" id="additional_images" class="form-control" accept="image/*" multiple>
                  <small class="text-muted">Можно выбрать несколько файлов</small>
                  {% if object.additional_images_set.all %}
                    <div class="mt-2">
                      <small class="text-muted">Текущие изображения:</small><br>
                      {% for img in object.additional_images_set.all %}
                        <img src="{{ img.image.url }}" alt="Дополнительное фото" class="img-thumbnail me-2" style="max-height: 80px;">
                      {% endfor %}
                    </div>
                  {% endif %}
                </div>
                
                <div class="mb-3">
                  <label class="form-label">{{ form.categories.label }}</label>
                  <div id="categoriesContainer" class="border p-3" style="max-height: 200px; overflow-y: auto;">
                    {% for choice in form.categories %}
                      <div class="form-check">
                        {{ choice.tag }}
                        <label class="form-check-label" for="{{ choice.id_for_label }}">
                          {{ choice.choice_label }}
                        </label>
                      </div>
                    {% endfor %}
                  </div>
                  {% if form.categories.errors %}
                    <div class="text-danger small">{{ form.categories.errors.0 }}</div>
                  {% endif %}
                </div>
                
                <div class="mb-3">
                  <label class="form-label">{{ form.products.label }}</label>
                  <div id="productsContainer" class="border p-3" style="max-height: 200px; overflow-y: auto;">
                    {% if object.products.exists %}
                      {% for product in object.products.all %}
                        <div class="form-check">
                          <input class="form-check-input" type="checkbox" name="products" value="{{ product.id }}" id="product_{{ product.id }}" checked>
                          <label class="form-check-label" for="product_{{ product.id }}">
                            {{ product.name }}
                          </label>
                        </div>
                      {% endfor %}
                    {% else %}
                      <div class="text-muted">Сначала выберите категории</div>
                    {% endif %}
                  </div>
                  {% if form.products.errors %}
                    <div class="text-danger small">{{ form.products.errors.0 }}</div>
                  {% endif %}
                </div>
                
                <div class="mb-3">
                  <label class="form-label">{{ form.assigned_employees.label }}</label>
                  <div id="employeesContainer" class="border p-3" style="max-height: 200px; overflow-y: auto;">
                    {% if object.assigned_employees.exists %}
                      {% for employee in object.assigned_employees.all %}
                        <div class="form-check">
                          <input class="form-check-input" type="checkbox" name="assigned_employees" value="{{ employee.id }}" id="employee_{{ employee.id }}" checked>
                          <label class="form-check-label" for="employee_{{ employee.id }}">
                            {{ employee.first_name }} {{ employee.last_name }}
                          </label>
                        </div>
                      {% endfor %}
                    {% else %}
                      <div class="text-muted">Сначала выберите категории</div>
                    {% endif %}
                  </div>
                  {% if form.assigned_employees.errors %}
                    <div class="text-danger small">{{ form.assigned_employees.errors.0 }}</div>
                  {% endif %}
                </div>
              </div>
            </div>
            
            <hr>
            
            <div class="d-flex justify-content-between">
              <a href="{% if object.pk %}{% url 'main:order_detail' object.pk %}{% else %}{% url 'main:order_list' %}{% endif %}" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left"></i> Отмена
              </a>
              <button type="submit" class="btn btn-primary">
                <i class="bi bi-check-lg"></i> Сохранить изменения
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const categoriesContainer = document.getElementById('categoriesContainer');
    const productsContainer = document.getElementById('productsContainer');
    const employeesContainer = document.getElementById('employeesContainer');
    
    // Функция для получения выбранных категорий
    function getSelectedCategories() {
        const checkboxes = categoriesContainer.querySelectorAll('input[type="checkbox"]:checked');
        return Array.from(checkboxes).map(cb => cb.value);
    }
    
    // Функция для загрузки товаров по категориям
    function loadProductsByCategories() {
        const selectedCategories = getSelectedCategories();
        
        if (selectedCategories.length === 0) {
            productsContainer.innerHTML = '<div class="text-muted">Сначала выберите категории</div>';
            return;
        }
        
        // Получаем уже выбранные товары
        const currentlySelected = Array.from(productsContainer.querySelectorAll('input[type="checkbox"]:checked')).map(cb => cb.value);
        const initialSelected = window.initialProducts || [];
        
        const params = new URLSearchParams();
        selectedCategories.forEach(id => params.append('category_ids[]', id));
        
        fetch(`{% url 'main:get_products_by_categories' %}?${params}`)
            .then(response => response.json())
            .then(data => {
                productsContainer.innerHTML = '';
                data.products.forEach(product => {
                    const isSelected = currentlySelected.includes(product.id.toString()) || initialSelected.includes(product.id.toString());
                    const div = document.createElement('div');
                    div.className = 'form-check';
                    div.innerHTML = `
                        <input class="form-check-input" type="checkbox" name="products" value="${product.id}" id="product_${product.id}" ${isSelected ? 'checked' : ''}>
                        <label class="form-check-label" for="product_${product.id}">
                            ${product.name}
                        </label>
                    `;
                    productsContainer.appendChild(div);
                });
            });
    }
    
    // Функция для загрузки мастеров по категориям
    function loadEmployeesByCategories() {
        const selectedCategories = getSelectedCategories();
        
        if (selectedCategories.length === 0) {
            employeesContainer.innerHTML = '<div class="text-muted">Сначала выберите категории</div>';
            return;
        }
        
        // Получаем уже выбранных мастеров
        const currentlySelected = Array.from(employeesContainer.querySelectorAll('input[type="checkbox"]:checked')).map(cb => cb.value);
        const initialSelected = window.initialEmployees || [];
        
        const params = new URLSearchParams();
        selectedCategories.forEach(id => params.append('category_ids[]', id));
        
        fetch(`{% url 'main:get_employees_by_categories' %}?${params}`)
            .then(response => response.json())
            .then(data => {
                employeesContainer.innerHTML = '';
                data.employees.forEach(employee => {
                    const isSelected = currentlySelected.includes(employee.id.toString()) || initialSelected.includes(employee.id.toString());
                    const div = document.createElement('div');
                    div.className = 'form-check';
                    div.innerHTML = `
                        <input class="form-check-input" type="checkbox" name="assigned_employees" value="${employee.id}" id="employee_${employee.id}" ${isSelected ? 'checked' : ''}>
                        <label class="form-check-label" for="employee_${employee.id}">
                            ${employee.name}
                        </label>
                    `;
                    employeesContainer.appendChild(div);
                });
            });
    }
    
    // Обработчик изменения категорий
    categoriesContainer.addEventListener('change', function(e) {
        if (e.target.type === 'checkbox') {
            loadProductsByCategories();
            loadEmployeesByCategories();
        }
    });
    
    // Инициализация при загрузке страницы
    if (getSelectedCategories().length > 0) {
        // Сохраняем изначально выбранные значения
        window.initialProducts = Array.from(document.querySelectorAll('input[name="products"]:checked')).map(cb => cb.value);
        window.initialEmployees = Array.from(document.querySelectorAll('input[name="assigned_employees"]:checked')).map(cb => cb.value);
        
        loadProductsByCategories();
        loadEmployeesByCategories();
    }
});
</script>
{% endblock content %}