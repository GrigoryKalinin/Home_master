{% extends 'private/employee_base.html' %}
{% load static %}

{% block title %}{{ title }}{% endblock title %}

{% block content %}
<div class="container mt-4">
  <div class="row justify-content-center">
    <div class="col-md-8">
      <div class="card">
        <div class="card-header">
          <h4 class="mb-0">{{ title }}</h4>
        </div>
        <div class="card-body">
          <form method="post" enctype="multipart/form-data">
            {% csrf_token %}
            
            <div class="row">
              <div class="col-md-6">
                <h6 class="text-muted mb-3">Информация о клиенте</h6>
                
                <div class="mb-3">
                  <label for="{{ form.name.id_for_label }}" class="form-label">{{ form.name.label }}</label>
                  {{ form.name }}
                  {% if form.name.errors %}
                    <div class="text-danger small">{{ form.name.errors.0 }}</div>
                  {% endif %}
                </div>
                
                <div class="mb-3">
                  <label for="{{ form.last_name.id_for_label }}" class="form-label">{{ form.last_name.label }}</label>
                  {{ form.last_name }}
                  {% if form.last_name.errors %}
                    <div class="text-danger small">{{ form.last_name.errors.0 }}</div>
                  {% endif %}
                </div>
                
                <div class="mb-3">
                  <label for="{{ form.middle_name.id_for_label }}" class="form-label">{{ form.middle_name.label }}</label>
                  {{ form.middle_name }}
                  {% if form.middle_name.errors %}
                    <div class="text-danger small">{{ form.middle_name.errors.0 }}</div>
                  {% endif %}
                </div>
                
                <div class="mb-3">
                  <label for="{{ form.phone.id_for_label }}" class="form-label">{{ form.phone.label }}</label>
                  {{ form.phone }}
                  {% if form.phone.errors %}
                    <div class="text-danger small">{{ form.phone.errors.0 }}</div>
                  {% endif %}
                </div>
                
                <div class="mb-3">
                  <label for="{{ form.city.id_for_label }}" class="form-label">{{ form.city.label }}</label>
                  {{ form.city }}
                  {% if form.city.errors %}
                    <div class="text-danger small">{{ form.city.errors.0 }}</div>
                  {% endif %}
                </div>
                
                <div class="mb-3">
                  <label for="{{ form.address.id_for_label }}" class="form-label">{{ form.address.label }}</label>
                  {{ form.address }}
                  {% if form.address.errors %}
                    <div class="text-danger small">{{ form.address.errors.0 }}</div>
                  {% endif %}
                </div>
              </div>
              
              <div class="col-md-6">
                <h6 class="text-muted mb-3">Информация о работе</h6>
                
                <div class="mb-3">
                  <label for="{{ form.work_description.id_for_label }}" class="form-label">{{ form.work_description.label }}</label>
                  {{ form.work_description }}
                  {% if form.work_description.errors %}
                    <div class="text-danger small">{{ form.work_description.errors.0 }}</div>
                  {% endif %}
                </div>
                
                <div class="mb-3">
                  <label for="additional_images" class="form-label">Дополнительные фотографии</label>
                  <input type="file" name="additional_images" id="additional_images" class="form-control" accept="image/*" multiple>
                  <small class="text-muted">Можно выбрать несколько файлов</small>
                  {% if object.additional_images_set.all %}
                    <div class="mt-2">
                      <small class="text-muted">Текущие изображения:</small><br>
                      {% for img in object.additional_images_set.all %}
                        <img src="{{ img.image.url }}" alt="Дополнительное фото" class="img-thumbnail me-2" style="max-height: 80px;">
                      {% endfor %}
                    </div>
                  {% endif %}
                </div>
                
                <div class="mb-3">
                  <label for="{{ form.category.id_for_label }}" class="form-label">{{ form.category.label }}</label>
                  {{ form.category }}
                  {% if form.category.errors %}
                    <div class="text-danger small">{{ form.category.errors.0 }}</div>
                  {% endif %}
                </div>
                
                <div class="mb-3">
                  <label for="{{ form.product.id_for_label }}" class="form-label">{{ form.product.label }}</label>
                  {{ form.product }}
                  {% if form.product.errors %}
                    <div class="text-danger small">{{ form.product.errors.0 }}</div>
                  {% endif %}
                </div>
                
                <div class="mb-3">
                  <label for="{{ form.assigned_employee.id_for_label }}" class="form-label">{{ form.assigned_employee.label }}</label>
                  {{ form.assigned_employee }}
                  {% if form.assigned_employee.errors %}
                    <div class="text-danger small">{{ form.assigned_employee.errors.0 }}</div>
                  {% endif %}
                </div>
              </div>
            </div>
            
            <hr>
            
            <div class="d-flex justify-content-between">
              <a href="{% url 'main:order_detail' object.pk %}" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left"></i> Отмена
              </a>
              <button type="submit" class="btn btn-primary">
                <i class="bi bi-check-lg"></i> Сохранить изменения
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const categorySelect = document.getElementById('categorySelect');
    const productSelect = document.getElementById('productSelect');
    const employeeSelect = document.getElementById('employeeSelect');
    
    // Функция для загрузки товаров по категории
    function loadProductsByCategory(categoryId) {
        if (!categoryId) {
            productSelect.innerHTML = '<option value="">Сначала выберите категорию</option>';
            productSelect.disabled = true;
            return;
        }
        
        fetch(`{% url 'main:get_products_by_category' %}?category_id=${categoryId}`)
            .then(response => response.json())
            .then(data => {
                productSelect.innerHTML = '<option value="">Выберите товар/услугу</option>';
                data.products.forEach(product => {
                    const option = document.createElement('option');
                    option.value = product.id;
                    option.textContent = product.name;
                    productSelect.appendChild(option);
                });
                productSelect.disabled = false;
            });
    }
    
    // Функция для загрузки мастеров по категории
    function loadEmployeesByCategory(categoryId) {
        if (!categoryId) {
            employeeSelect.innerHTML = '<option value="">Сначала выберите категорию</option>';
            employeeSelect.disabled = true;
            return;
        }
        
        fetch(`{% url 'main:get_employees_by_category' %}?category_id=${categoryId}`)
            .then(response => response.json())
            .then(data => {
                employeeSelect.innerHTML = '<option value="">Выберите мастера</option>';
                data.employees.forEach(employee => {
                    const option = document.createElement('option');
                    option.value = employee.id;
                    option.textContent = employee.name;
                    employeeSelect.appendChild(option);
                });
                employeeSelect.disabled = false;
            });
    }
    
    // Обработчик изменения категории
    categorySelect.addEventListener('change', function() {
        const categoryId = this.value;
        loadProductsByCategory(categoryId);
        loadEmployeesByCategory(categoryId);
    });
    
    // Инициализация при загрузке страницы
    if (categorySelect.value) {
        loadProductsByCategory(categorySelect.value);
        loadEmployeesByCategory(categorySelect.value);
    }
});
</script>
{% endblock content %}