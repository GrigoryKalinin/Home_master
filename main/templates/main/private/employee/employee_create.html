{% extends 'private/employee_base.html' %}
{% load static %}

{% block title %}Добавление сотрудника{% endblock title%}

{% block content %}
<div class="container mt-4">
  <div class="row justify-content-center">
    <div class="col-md-8">
      <div class="card">
        <div class="card-header">
          <h4 class="mb-0">
            {% if form.instance.pk %}
              Редактирование {{ form.instance.first_name }} {{ form.instance.last_name }}
            {% else %}
              Добавление нового сотрудника
            {% endif %}
          </h4>
        </div>
        <div class="card-body">
          <form method="post" enctype="multipart/form-data">
            {% csrf_token %}
            
            <div class="row">
              <div class="col-md-6 mb-3">
                {{ form.first_name.label_tag }}
                {{ form.first_name }}
              </div>
              <div class="col-md-6 mb-3">
                {{ form.last_name.label_tag }}
                {{ form.last_name }}
              </div>
            </div>
            
            <div class="mb-3">
							{{ form.middle_name.label_tag }}
							{{ form.middle_name }}
            </div>

            <div class="row">
              <div class="col-md-6 mb-3">
                {{ form.birth_date.label_tag }}
                {{ form.birth_date }}
              </div>
              <div class="col-md-6 mb-3">
                {{ form.phone.label_tag }}
                {{ form.phone }}
              </div>
            </div>

            <div class="row">
              <div class="col-md-6 mb-3">
                {{ form.email.label_tag }}
                {{ form.email }}
              </div>
              <div class="col-md-6 mb-3">
                {{ form.city.label_tag }}
                {{ form.city }}
              </div>
            </div>

            <div class="mb-3">
              {{ form.specialization.label_tag }}
              <div id="specializationContainer" class="border p-3" style="max-height: 200px; overflow-y: auto;">
                {% for specialization in form.specialization.field.queryset %}
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" name="specialization" value="{{ specialization.id }}" id="spec_{{ specialization.id }}" {% if specialization.id in form.specialization.value %}checked{% endif %}>
                  <label class="form-check-label" for="spec_{{ specialization.id }}">
                    {{ specialization.name }}
                  </label>
                </div>
                {% endfor %}
              </div>
            </div>
            
            <div class="mb-3">
              {{ form.categories.label_tag }}
              <div id="categoriesContainer" class="border p-3" style="max-height: 200px; overflow-y: auto;">
                {% if form.categories.field.queryset %}
                  {% for category in form.categories.field.queryset %}
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" name="categories" value="{{ category.id }}" id="cat_{{ category.id }}" {% if category.id in form.categories.value %}checked{% endif %}>
                    <label class="form-check-label" for="cat_{{ category.id }}">
                      {{ category.name }}
                    </label>
                  </div>
                  {% endfor %}
                {% else %}
                  <div class="text-muted">Сначала выберите специализацию</div>
                {% endif %}
              </div>
            </div>
            
            <div class="mb-3">
              {{ form.products.label_tag }}
              <div id="productsContainer" class="border p-3" style="max-height: 200px; overflow-y: auto;">
                {% if form.products.field.queryset %}
                  {% for product in form.products.field.queryset %}
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" name="products" value="{{ product.id }}" id="product_{{ product.id }}" {% if product.id in form.products.value %}checked{% endif %}>
                    <label class="form-check-label" for="product_{{ product.id }}">
                      {{ product.name }}
                    </label>
                  </div>
                  {% endfor %}
                {% else %}
                  <div class="text-muted">Сначала выберите специализацию</div>
                {% endif %}
              </div>
            </div>
            
            <div class="mb-3">
              {{ form.services.label_tag }}
              <div id="servicesContainer" class="border p-3" style="max-height: 200px; overflow-y: auto;">
                {% if form.services.field.queryset %}
                  {% for service in form.services.field.queryset %}
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" name="services" value="{{ service.id }}" id="service_{{ service.id }}" {% if service.id in form.services.value %}checked{% endif %}>
                    <label class="form-check-label" for="service_{{ service.id }}">
                      {{ service.name }}
                    </label>
                  </div>
                  {% endfor %}
                {% else %}
                  <div class="text-muted">Сначала выберите товары</div>
                {% endif %}
              </div>
            </div>
            
            <div class="mb-3">
              {{ form.experience.label_tag }}
              {{ form.experience }}
            </div>

            <div class="row">
              <div class="col-md-6 mb-3">
                {{ form.date_hired.label_tag }}
                {{ form.date_hired }}
              </div>
              <div class="col-md-6 mb-3">
                {{ form.status.label_tag }}
                {{ form.status }}
              </div>
            </div>

      <div class="mb-3">
        {{ form.image.label_tag }}
        {{ form.image }}
      </div>

            <div class="d-flex justify-content-between">
              <button type="submit" class="btn btn-success">
                <i class="bi bi-check-lg"></i> 
                {% if form.instance.pk %}
                  Сохранить
                {% else %}
                  Добавить
                {% endif %}
              </button>
              <a href="{% url 'main:employee_list' %}" class="btn btn-secondary">
                <i class="bi bi-arrow-left"></i> Назад
              </a>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock content%}

{% block script%}
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.inputmask/5.0.8/jquery.inputmask.min.js"></script>
  <script src="{% static 'js/phone_mask.js' %}"></script>
  
  <script>
  document.addEventListener('DOMContentLoaded', function() {
    const specializationContainer = document.getElementById('specializationContainer');
    const categoriesContainer = document.getElementById('categoriesContainer');
    const productsContainer = document.getElementById('productsContainer');
    const servicesContainer = document.getElementById('servicesContainer');
    
    let selectedProducts = [];
    let selectedServices = [];
    
    // Сохраняем выбранные значения при редактировании
    productsContainer.querySelectorAll('input[type="checkbox"]:checked').forEach(cb => {
      selectedProducts.push(cb.value);
    });
    servicesContainer.querySelectorAll('input[type="checkbox"]:checked').forEach(cb => {
      selectedServices.push(cb.value);
    });
    
    // Инициализация при редактировании - если есть выбранные категории, загружаем товары
    const checkedCategories = categoriesContainer.querySelectorAll('input[type="checkbox"]:checked');
    if (checkedCategories.length > 0) {
      loadProductsByCategories();
    }
    
    function loadCategoriesBySpecializations() {
      const selectedSpecs = Array.from(specializationContainer.querySelectorAll('input[type="checkbox"]:checked')).map(cb => cb.value);
      
      if (selectedSpecs.length === 0) {
        categoriesContainer.innerHTML = '<div class="text-muted">Сначала выберите специализацию</div>';
        productsContainer.innerHTML = '<div class="text-muted">Сначала выберите специализацию</div>';
        servicesContainer.innerHTML = '<div class="text-muted">Сначала выберите товары</div>';
        return;
      }
      
      const params = new URLSearchParams();
      selectedSpecs.forEach(id => params.append('specialization_ids[]', id));
      
      fetch(`{% url 'main:get_categories_by_specialization' %}?${params}`)
        .then(response => response.json())
        .then(data => {
          categoriesContainer.innerHTML = '';
          data.categories.forEach(category => {
            const div = document.createElement('div');
            div.className = 'form-check';
            div.innerHTML = `
              <input class="form-check-input" type="checkbox" name="categories" value="${category.id}" id="cat_${category.id}">
              <label class="form-check-label" for="cat_${category.id}">
                ${category.name}
              </label>
            `;
            categoriesContainer.appendChild(div);
          })
        });
    }
    
    function loadProductsByCategories() {
      const selectedCategories = Array.from(categoriesContainer.querySelectorAll('input[type="checkbox"]:checked')).map(cb => cb.value);
      
      if (selectedCategories.length === 0) {
        productsContainer.innerHTML = '<div class="text-muted">Сначала выберите категории</div>';
        servicesContainer.innerHTML = '<div class="text-muted">Сначала выберите товары</div>';
        return;
      }
      
      const params = new URLSearchParams();
      selectedCategories.forEach(id => params.append('category_ids[]', id));
      
      fetch(`{% url 'main:get_products_by_categories' %}?${params}`)
        .then(response => response.json())
        .then(data => {
          productsContainer.innerHTML = '';
          data.products.forEach(product => {
            const isSelected = selectedProducts.includes(product.id.toString());
            const div = document.createElement('div');
            div.className = 'form-check';
            div.innerHTML = `
              <input class="form-check-input" type="checkbox" name="products" value="${product.id}" id="product_${product.id}" ${isSelected ? 'checked' : ''}>
              <label class="form-check-label" for="product_${product.id}">
                ${product.name}
              </label>
            `;
            productsContainer.appendChild(div);
          });
          
          loadServicesByProducts();
        });
    }
    
    function loadServicesByProducts() {
      const selectedProductsNow = Array.from(productsContainer.querySelectorAll('input[type="checkbox"]:checked')).map(cb => cb.value);
      
      if (selectedProductsNow.length === 0) {
        servicesContainer.innerHTML = '<div class="text-muted">Выберите товары</div>';
        return;
      }
      
      const params = new URLSearchParams();
      selectedProductsNow.forEach(id => params.append('product_ids[]', id));
      
      fetch(`{% url 'main:get_services_by_products' %}?${params}`)
        .then(response => response.json())
        .then(data => {
          servicesContainer.innerHTML = '';
          data.services.forEach(service => {
            const isSelected = selectedServices.includes(service.id.toString());
            const div = document.createElement('div');
            div.className = 'form-check';
            div.innerHTML = `
              <input class="form-check-input" type="checkbox" name="services" value="${service.id}" id="service_${service.id}" ${isSelected ? 'checked' : ''}>
              <label class="form-check-label" for="service_${service.id}">
                ${service.name}
              </label>
            `;
            servicesContainer.appendChild(div);
          });
        });
    }
    
    specializationContainer.addEventListener('change', function(e) {
      if (e.target.type === 'checkbox') {
        loadCategoriesBySpecializations();
      }
    });
    
    categoriesContainer.addEventListener('change', function(e) {
      if (e.target.type === 'checkbox') {
        loadProductsByCategories();
      }
    });
    
    productsContainer.addEventListener('change', function(e) {
      if (e.target.type === 'checkbox') {
        loadServicesByProducts();
      }
    });
  });
  </script>
{% endblock script%}